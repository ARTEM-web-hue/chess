<script>
  // Имя из localStorage
  let author = localStorage.getItem('author') || "Гость";

  const ws = new WebSocket(`wss://${location.host}/ws`);
  const messages = document.getElementById('messages');
  const input = document.getElementById('input');
  const fileInput = document.getElementById('file');

  ws.onmessage = (event) => {
    const div = document.createElement('div');
    div.innerHTML = linkify(event.data);
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
  };

  document.getElementById('send').onclick = sendText;
  input.onkeypress = (e) => { if (e.key === 'Enter') sendText(); };

  fileInput.onchange = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    if (file.size > 500 * 1024) {
      alert("Изображение слишком большое! Максимум 500 КБ.");
      return;
    }
    const reader = new FileReader();
    reader.onload = () => {
      ws.send(`${author}|${reader.result}`);
      fileInput.value = '';
    };
    reader.readAsDataURL(file);
  };

  function sendText() {
    const text = input.value.trim();
    if (text) {
      ws.send(`${author}|${text}`);
      input.value = '';
    }
  }

  function linkify(text) {
    let safe = text
      .replace(/&/g, '&amp;')
      .replace(/</g, '<')
      .replace(/>/g, '>');
    safe = safe.replace(/(https?:\/\/[^\s<>"{}|\\^`]+)/g, url => 
      `<a href="${url}" target="_blank">${url}</a>`
    );
    safe = safe.replace(/(data:image\/[a-z]+;base64,[A-Za-z0-9+/=]+)/g, img =>
      `<img src="${img}" alt="image" style="max-width:100%; max-height:300px; border-radius:4px; margin-top:6px;">`
    );
    return safe;
  }

  // Смена имени по Ctrl+1 / Cmd+1
  document.addEventListener('keydown', (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key === '1') {
      e.preventDefault();
      const newName = prompt("Как тебя теперь зовут?", author);
      if (newName && newName.trim()) {
        author = newName.trim();
        localStorage.setItem('author', author);
        // Опционально: отправить уведомление в чат
        ws.send(`${author}|изменил(а) имя`);
      }
    }
  });
</script>
