<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Quick Chess</title>
  <style>
    body {
      margin: 0;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      font-family: sans-serif;
      background: #f0f0f0;
    }
    #status {
      font-size: 24px;
      color: #555;
    }
    #board {
      display: none;
      width: min(90vw, 90vh);
      max-width: 600px;
    }
  </style>
</head>
<body>
  <div id="status">Подбираем соперника…</div>
  <div id="board"></div>

  <!-- Загружаем библиотеки СИНХРОННО -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css">

  <script>
    let board = null;
    let gameOver = false;
    const ws = new WebSocket(`wss://${window.location.host}/ws`);

    ws.onmessage = (event) => {
      const msg = event.data;

      if (msg.startsWith("color:")) {
        const color = msg.split(":")[1];
        document.getElementById("status").style.display = "none";
        document.getElementById("board").style.display = "block";

        // Создаём доску ТОЛЬКО после загрузки библиотек
        board = Chessboard('board', {
          position: 'start',
          draggable: true,
          onDragStart: (source, piece) => {
            if (gameOver) return false;
            // Белые — 'w', чёрные — 'b'
            return (color === 'white') ? piece.startsWith('w') : piece.startsWith('b');
          },
          onDrop: (source, target) => {
            const move = source + target;
            ws.send(move);
          }
        });
      }
      else if (msg.startsWith("fen:") && board) {
        const fen = msg.split(":")[1];
        board.position(fen);
      }
      else if (msg.startsWith("result:") || msg === "resign") {
        gameOver = true;
        alert("Игра окончена!");
        location.reload();
      }
    };

    ws.onclose = () => {
      if (!gameOver) {
        alert("Соединение с сервером потеряно.");
      }
      location.reload();
    };
  </script>
</body>
</html>
